name: CI/CD using GitHub Actions & Docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # SSH í‚¤ ì„¤ì •
      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} 2>/dev/null >> ~/.ssh/known_hosts
          ls -la ~/.ssh/id_rsa || echo "SSH key file not found"

      - name: Test SSH Connection
        run: ssh -q -o "StrictHostKeyChecking=no" ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"

      # ë°°í¬ ì‹œì‘ ì•Œë¦¼
      - name: Notify deployment start
        run: echo "ğŸš€ ë°°í¬ ì‹œì‘: $(date)"

      # Node.js & ìºì‹œ ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build

      # Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/saykotoba-backend:$TIMESTAMP
          DOCKER_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/saykotoba-backend:latest

          docker build -t $DOCKER_IMAGE -t $DOCKER_LATEST .
          docker push $DOCKER_IMAGE
          docker push $DOCKER_LATEST

      # EC2 ìƒíƒœ ì ê²€
      - name: Check EC2 Status
        run: ssh -q -o "StrictHostKeyChecking=no" ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          echo "=== CPU Usage ==="
          top -bn1 | grep "Cpu(s)"
          echo "=== Memory Usage ==="
          free -m
          echo "=== Process List ==="
          ps aux --sort=-%mem | head -5
        EOF

      # ì„œë²„ì— ë°°í¬ ì‹¤í–‰
      - name: Deploy to EC2
        run: ssh -q -o "StrictHostKeyChecking=no" ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          set -e

          echo "ğŸ”„ ë°°í¬ ì¤‘..."
          cd ~/saykotoba-backend || { echo "ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }

          # í™˜ê²½ ë³€ìˆ˜ ì ìš©
          echo "${{ secrets.ENV_PROD }}" > config/env/.env.prod

          # ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ë° ì¬ì‹œì‘
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/saykotoba-backend:latest
          docker-compose down
          docker-compose up -d

          echo "ğŸ©º í—¬ìŠ¤ì²´í¬ ì‹¤í–‰..."
          for i in {1..10}; do
            sleep 5
            if curl -f http://localhost:8080/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ í†µê³¼!"
              exit 0
            fi
            echo "â³ ì¬ì‹œë„ ì¤‘..."
          done

          echo "ğŸš¨ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨! ì„œë²„ ë¡œê·¸ í™•ì¸ í•„ìš”"
          docker logs $(docker ps --format '{{.Names}}' | grep backend || echo "backend")
          exit 1
        EOF

      # ì›ê²© ì„œë²„ì˜ í—¬ìŠ¤ì²´í¬
      - name: Health check
        run: |
          sleep 5
          for i in {1..5}; do
            if curl --fail http://${{ secrets.EC2_HOST }}:8080/health; then
              echo "âœ… ì„œë²„ ì •ìƒ ë™ì‘"
              exit 0
            fi
            echo "â³ í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ($i/5)..."
            sleep 5
          done
          echo "ğŸš¨ ìµœì¢… í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨!"
          exit 1

      # ë””ìŠ¤í¬ ìš©ëŸ‰ ì ê²€
      - name: Check disk space
        run: ssh -q ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "df -h"

      # Docker ìƒíƒœ ì ê²€
      - name: Check Docker status
        if: always()
        run: ssh -q ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
          echo "===== Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ ====="
          docker ps
          echo "===== Docker ì‹œìŠ¤í…œ ì •ë³´ ====="
          docker system df
        EOF

      # ë¶ˆí•„ìš”í•œ ìºì‹œ ì •ë¦¬
      - name: Cleanup
        if: always()
        run: |
          yarn cache clean
          docker system prune -af || true

      # ë°°í¬ ê²°ê³¼ ìŠ¬ë™ ì•Œë¦¼
      - name: Notify deployment result
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
