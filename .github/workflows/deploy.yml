name: CI/CD using github actions & docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # SSH í‚¤ ì„¤ì •
      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" | tr -d '\r' | tee ~/.ssh/id_rsa > /dev/null
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          ls -la ~/.ssh/id_rsa || echo "SSH key file not found"
      - name: Test SSH Connection
        run: ssh -q -o "StrictHostKeyChecking=no" ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'SSH connection successful'"

      # ë°°í¬ ì‹œì‘ ì•Œë¦¼
      - name: Notify deployment start
        run: echo "ğŸš€ ë°°í¬ ì‹œì‘ - $(date)"

      # Node.js & ìºì‹œ ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install

      - name: Build application
        run: yarn build

      # Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          DOCKER_IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/saykotoba-backend:$TIMESTAMP
          DOCKER_LATEST=${{ secrets.DOCKERHUB_USERNAME }}/saykotoba-backend:latest
          docker build -t $DOCKER_IMAGE -t $DOCKER_LATEST .
          docker push $DOCKER_IMAGE
          docker push $DOCKER_LATEST

      # EC2 ìƒíƒœ ì ê²€
      - name: Check EC2 Status
        run: |
          ssh -q -o "StrictHostKeyChecking=no" ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "=== CPU Usage ==="
            top -bn1 | grep "Cpu(s)"
            echo "=== Memory Usage ==="
            free -m
            echo "=== Process List ==="
            ps aux --sort=-%mem | head -5
          EOF

      # ì„œë²„ì— ë°°í¬ ì‹¤í–‰
      - name: Deploy to EC2
        run: |
          ssh -v -o "StrictHostKeyChecking=no" ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          # ë””ë²„ê¹…ì„ ìœ„í•œ ë””ë ‰í† ë¦¬ í™•ì¸
          echo "Checking directories..."
          ls -la /home/$USER/saykotoba-backend/config/

          cd /home/$USER/saykotoba-backend

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (echo í•œ ë²ˆì— ì²˜ë¦¬)
          echo "${{ secrets.ENV_PROD }}" > config/env/.env.prod

          # docker-compose ì‹¤í–‰ ì „ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo "Checking environment variables..."
          cat config/env/.env.prod

          # ìµœì‹  ì´ë¯¸ì§€ í’€ ë° ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/saykotoba-backend:latest

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          docker-compose down --remove-orphans

          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ì „ ë¡œê·¸
          echo "Starting container..."
          docker-compose up -d

          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
          echo "Container logs:"
          docker logs backend --tail 50

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "Container status:"
          docker ps

          # í—¬ìŠ¤ì²´í¬ ì „ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
          echo "Waiting for application to start..."
          sleep 30

          # í—¬ìŠ¤ì²´í¬
          if ! curl -f http://localhost:8080/health; then
            echo "Health check failed!"
            docker logs backend
            exit 1
          fi
          ENDSSH

      # ì›ê²© ì„œë²„ì˜ í—¬ìŠ¤ì²´í¬
      - name: Health check
        run: |
          sleep 10
          curl --fail http://${{ secrets.EC2_HOST }}:8080/health || exit 1

      # ë””ìŠ¤í¬ ìš©ëŸ‰ ì ê²€
      - name: Check disk space
        run: ssh -q ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "df -h"

      # Docker ìƒíƒœ ì ê²€
      - name: Check Docker status
        if: always()
        run: |
          ssh -q ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "===== Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ ====="
            docker ps
            echo "===== Docker ì‹œìŠ¤í…œ ì •ë³´ ====="
            docker system df
          EOF

      # ë¶ˆí•„ìš”í•œ ìºì‹œ ì •ë¦¬
      - name: Cleanup
        if: always()
        run: |
          yarn cache clean
          docker system prune -af || true

      # ë°°í¬ ê²°ê³¼ ìŠ¬ë™ ì•Œë¦¼
      - name: Notify deployment result
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
